<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>AlfieVR - Robot Arm Teleoperation</title>
    <meta name="description" content="AlfieVR - Robot Arm Teleoperation">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://aframe.io/releases/1.7.1/aframe.min.js"></script>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <!-- Three.js OBJLoader for URDF viewer (uses A-Frame's bundled THREE) -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/examples/js/loaders/OBJLoader.js"></script>
    <script src="vr_app.js" defer></script>
    <script src="interface.js" defer></script>
    <script src="urdf_viewer.js" defer></script>
    <link rel="stylesheet" href="styles.css">
  </head>
  <body>
    <!-- Hidden canvas for video texture -->
    <canvas id="videoCanvas" width="640" height="480" style="display: none;"></canvas>

    <!-- Settings Button -->
    <div class="settings-button" onclick="openSettings()">
      ‚öôÔ∏è
    </div>

    <!-- Settings Modal -->
    <div class="settings-modal" id="settingsModal">
      <div class="settings-content">
        <div class="settings-header">
          <div class="settings-title">System Configuration</div>
          <button class="close-button" onclick="closeSettings()">√ó</button>
        </div>
        
        <form id="settingsForm">
          <div class="settings-section">
            <h3>ü§ñ Robot Arms</h3>
            <div class="form-row">
              <div class="form-group">
                <label for="leftArmName">Left Arm Name</label>
                <input type="text" id="leftArmName" name="leftArmName">
              </div>
              <div class="form-group">
                <label for="leftArmPort">Left Arm Port</label>
                <input type="text" id="leftArmPort" name="leftArmPort" placeholder="/dev/ttyACM0">
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="rightArmName">Right Arm Name</label>
                <input type="text" id="rightArmName" name="rightArmName">
              </div>
              <div class="form-group">
                <label for="rightArmPort">Right Arm Port</label>
                <input type="text" id="rightArmPort" name="rightArmPort" placeholder="/dev/ttyACM1">
              </div>
            </div>
          </div>

          <div class="settings-section">
            <h3>üåê Network Settings</h3>
            <div class="form-row">
              <div class="form-group">
                <label for="httpsPort">HTTPS Port</label>
                <input type="number" id="httpsPort" name="httpsPort" min="1024" max="65535">
              </div>
              <div class="form-group">
                <label for="websocketPort">WebSocket Port</label>
                <input type="number" id="websocketPort" name="websocketPort" min="1024" max="65535">
              </div>
            </div>
            <div class="form-group">
              <label for="hostIp">Host IP Address</label>
              <input type="text" id="hostIp" name="hostIp" placeholder="0.0.0.0">
            </div>
          </div>

          <div class="settings-section">
            <h3>üéÆ Control Parameters</h3>
            <div class="form-row">
              <div class="form-group">
                <label for="vrScale">VR Scale Factor</label>
                <input type="number" id="vrScale" name="vrScale" step="0.1" min="0.1" max="5.0">
              </div>
              <div class="form-group">
                <label for="sendInterval">Send Interval (ms)</label>
                <input type="number" id="sendInterval" name="sendInterval" step="1" min="10" max="200">
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="posStep">Position Step (m)</label>
                <input type="number" id="posStep" name="posStep" step="0.001" min="0.001" max="0.1">
              </div>
              <div class="form-group">
                <label for="angleStep">Angle Step (degrees)</label>
                <input type="number" id="angleStep" name="angleStep" step="0.5" min="0.5" max="45">
              </div>
            </div>
          </div>

          <div class="button-row">
            <button type="submit" class="save-button" id="saveButton">
              üíæ Save Configuration
            </button>
            <button type="button" class="restart-button" id="restartButton" onclick="restartSystem()">
              üîÑ Restart System
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Desktop Interface -->
    <div class="desktop-interface" id="desktopInterface">
      <div class="desktop-header">
        <div class="desktop-title">AlfieVR</div>
        <div class="desktop-subtitle">Dual-arm robot control via VR controllers and keyboard</div>
        
        <div class="status-section">
          <h2>ü§ñ Robot Status</h2>
          <div class="status-grid">
            <div class="status-item">
              <div class="status-indicator" id="leftArmStatus"></div>
              <span>Left Arm</span>
            </div>
            <div class="status-item">
              <div class="status-indicator" id="rightArmStatus"></div>
              <span>Right Arm</span>
            </div>
            <div class="status-item">
              <div class="status-indicator" id="vrStatus"></div>
              <span>VR Connected</span>
            </div>
          </div>
          
          <!-- Robot Engagement Controls -->
          <div class="robot-controls">
            <button id="robotEngageBtn" class="engage-btn" onclick="toggleRobotEngagement()">
              <span id="engageBtnText">üîå Connect Robot</span>
            </button>
            <div class="engagement-status">
              <span id="engagementStatusText">Motors Disengaged</span>
            </div>
          </div>
        </div>

        <!-- VR Instructions Section -->
        <div class="vr-instructions-section">
          <h2>ü•Ω VR Controller Instructions</h2>
          <div class="instructions-content">
            <div class="instructions-image">
              <img src="media/telegrip_instructions.jpg" alt="VR Controller Instructions" style="max-width: 100%; height: auto; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
            </div>
            <div class="instructions-text">
              <div class="instruction-item">
                <strong>Setup:</strong> Go to <span id="vrServerUrl" style="font-family: monospace; background: rgba(255,255,255,0.2); padding: 2px 6px; border-radius: 4px;">https://loading...</span> in your headset's browser and click "Start"
              </div>
              <div class="instruction-item">
                <strong>Grip Button:</strong> The robot arm's gripper tip will track your relative controller movements as long as you hold the grip button
              </div>
              <div class="instruction-item">
                <strong>Controller Orientation:</strong> Roll and pitch of your controller will be matched on the wrist joint of the robot arm
              </div>
              <div class="instruction-item">
                <strong>Trigger Button:</strong> The gripper stays closed while you hold the trigger button. Release the trigger button to open the gripper.
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="keyboard-help">
        <!-- Collapsed state: just the enable button -->
        <div class="keyboard-help-collapsed">
          <div class="control-toggle" id="keyboardToggle" onclick="toggleKeyboardControl()">
            <span>üéÆ</span>
            <span id="keyboardToggleText">Enable Keyboard Control</span>
          </div>
        </div>
        
        <!-- Expanded state: title, disable button, and content -->
        <div class="keyboard-help-expanded">
          <div class="keyboard-help-header">
            <div class="control-toggle active" onclick="toggleKeyboardControl()">
              <span>üéÆ</span>
              <span>Disable Keyboard Control</span>
            </div>
            <div class="help-title">
              <span>‚å®Ô∏è</span>
              Keyboard Controls
            </div>
          </div>
          
          <div class="help-columns">
            <div class="help-column">
              <h4>Left Arm</h4>
              <div class="key-group">
                <div class="key-row">
                  <span><kbd class="key">W</kbd> / <kbd class="key">S</kbd></span>
                  <span class="key-desc">Forward / Backward</span>
                </div>
                <div class="key-row">
                  <span><kbd class="key">A</kbd> / <kbd class="key">D</kbd></span>
                  <span class="key-desc">Left / Right</span>
                </div>
                <div class="key-row">
                  <span><kbd class="key">Q</kbd> / <kbd class="key">E</kbd></span>
                  <span class="key-desc">Down / Up</span>
                </div>
                <div class="key-row">
                  <span><kbd class="key">Z</kbd> / <kbd class="key">X</kbd></span>
                  <span class="key-desc">Wrist Roll</span>
                </div>
                <div class="key-row">
                  <span><kbd class="key">F</kbd></span>
                  <span class="key-desc">Toggle Gripper</span>
                </div>
              </div>
            </div>
            
            <div class="help-column">
              <h4>Right Arm</h4>
              <div class="key-group">
                <div class="key-row">
                  <span><kbd class="key">I</kbd> / <kbd class="key">K</kbd></span>
                  <span class="key-desc">Forward / Backward</span>
                </div>
                <div class="key-row">
                  <span><kbd class="key">J</kbd> / <kbd class="key">L</kbd></span>
                  <span class="key-desc">Left / Right</span>
                </div>
                <div class="key-row">
                  <span><kbd class="key">U</kbd> / <kbd class="key">O</kbd></span>
                  <span class="key-desc">Up / Down</span>
                </div>
                <div class="key-row">
                  <span><kbd class="key">N</kbd> / <kbd class="key">M</kbd></span>
                  <span class="key-desc">Wrist Roll</span>
                </div>
                <div class="key-row">
                  <span><kbd class="key">;</kbd></span>
                  <span class="key-desc">Toggle Gripper</span>
                </div>
              </div>
            </div>
          </div>
          
          <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #bdc3c7; color: #7f8c8d; font-size: 13px;">
            <strong>Tips:</strong> Position control activates automatically when you press movement keys. 
            Use <kbd class="key">ESC</kbd> to stop the system.
          </div>
        </div>
      </div>
    </div>

    <!-- Robot Viewer Panel (right side) -->
    <div class="robot-viewer-panel" id="robotViewerPanel">
      <div class="robot-viewer-header">
        <div class="robot-viewer-title">ü§ñ Robot State</div>
        <div class="robot-viewer-controls">
          <button class="viewer-btn" id="resetViewBtn" title="Reset View">‚Üª</button>
          <button class="viewer-btn" id="toggleViewerBtn" title="Minimize">‚àí</button>
        </div>
      </div>
      <div class="robot-viewer-status" id="urdfViewerStatus">Initializing...</div>
      <div class="robot-viewer-container" id="urdfViewerContainer"></div>
      <div class="robot-viewer-info">
        <div class="viewer-info-row">
          <span class="info-label">Foxglove:</span>
          <span class="info-value" id="foxgloveStatus">Disconnected</span>
        </div>
        <div class="viewer-info-row">
          <span class="info-label">TF Updates:</span>
          <span class="info-value" id="tfUpdateCount">0</span>
        </div>
        <div class="viewer-info-row" id="certWarning" style="display: none;">
          <a href="#" id="acceptCertLink" target="_blank" style="color: #f39c12; font-size: 11px;">
            ‚ö†Ô∏è Click here to accept Foxglove certificate
          </a>
        </div>
      </div>
    </div>

    <!-- VR-only content -->
    <div class="vr-content" id="vrContent">
      <div class="vr-title">VR Teleoperation</div>
    </div>

    <!-- A-Frame VR Scene -->
    <a-scene vr-mode-ui="enabled: true;">
      <!-- Passthrough setup -->
      <a-entity webxr-passthrough="referenceSpaceType: local-floor"></a-entity>

      <!-- Headset tracking entity -->
      <a-entity id="headset" camera>
        <a-text id="headsetInfo" value="Headset: ..." position="0 -0.60 -2.0" rotation="0 0 0" scale="0.2 0.2 0.2" color="yellow" align="center"></a-text>
        <!-- Video Screen (Head Locked - follows headset view) -->
        <a-plane id="videoScreen" position="0 -0.4 -3.0" width="1.8" height="1.2" material="shader: flat; src: #videoCanvas" visible="false"></a-plane>
        
        <!-- VR Robot Viewer Panel (Head Locked - follows headset view) -->
        <a-entity id="vrRobotViewer" position="1.5 -0.5 -3.0" rotation="0 -20 0" scale="1.5 1.5 1.5" vr-robot-viewer>
          <!-- Panel background -->
          <a-plane id="vrRobotPanel" width="0.6" height="1.0" color="#1a1a2e" opacity="1.0" 
                   material="shader: flat; side: double"></a-plane>
          
          <!-- Panel header -->
          <a-plane position="0 0.47 0.001" width="0.58" height="0.06" color="#667eea" 
                   material="shader: flat"></a-plane>
          <a-text value="ü§ñ Robot State" position="0 0.47 0.002" align="center" 
                  color="white" scale="0.08 0.08 0.08"></a-text>
          
          <!-- Status text -->
          <a-text id="vrRobotStatus" value="Connecting..." position="-0.27 0.40 0.002" 
                  align="left" color="#aaaaaa" scale="0.04 0.04 0.04"></a-text>
          
          <!-- Robot model container (scaled down) -->
          <a-entity id="vrRobotModel" position="0 -0.175 0.15" scale="0.6 0.6 0.6" rotation="0 180 0">
            <!-- Robot model will be dynamically added here -->
          </a-entity>
          
          <!-- Grid floor for reference -->
          <a-entity position="0 -0.47 0.05">
            <a-plane width="0.5" height="0.3" rotation="-90 0 0" color="#333344" 
                     material="shader: flat; opacity: 0.5"></a-plane>
          </a-entity>
        </a-entity>
      </a-entity>

      <!-- Controllers -->
      <a-entity id="leftHand" oculus-touch-controls="hand: left">
        <a-text id="leftHandInfo" value="Pos: ...\nRot: ..." position="0 0.04 -0.05" rotation="0 0 0" scale="0.05 0.05 0.05" color="white" align="center"></a-text>
      </a-entity>
      <a-entity id="rightHand" oculus-touch-controls="hand: right">
        <a-text id="rightHandInfo" value="Pos: ...\nRot: ..." position="0 0.04 -0.05" rotation="0 0 0" scale="0.05 0.05 0.05" color="white" align="center"></a-text>
      </a-entity>
    </a-scene>

    <script>
      // Update VR server URL dynamically
      document.addEventListener('DOMContentLoaded', function() {
        const vrUrlElement = document.getElementById('vrServerUrl');
        if (vrUrlElement) {
          const currentUrl = window.location.origin;
          vrUrlElement.textContent = currentUrl + '/';
        }
      });
    </script>
  </body>
</html> 